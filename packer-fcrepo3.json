/*

  This is my source version of the packer-fcrepo3 build.  It contains
  comments which are stripped out of the file before it's fed to the
  Packer.io build process.  There should also be an fcrepo3.json file
  in this directory.  That file is the same as this one, sans comments.

  If you want to run the build, but don't have the strip-json-comments
  program installed, the build script will use fcrepo3.json (not this file).

*/

{
  "variables": {
    /* Below variables are hard-coded for this project */
    "fcrepo3_version": "3.8.0",
    "fcrepo3_services_version": "3.7",
    "gsearch_version": "2.7.1",
    "packer_fcrepo3_version": "0.1.0",
    "sourceforge_downloads": "http://downloads.sourceforge.net/project",
    /* The build script will overwrite below var if building from a forked repo */
    "packer_fcrepo3_repo": "http://github.com/ksclarke/packer-fcrepo3",
    /* Below builder variables should be supplied by the vars.json file */
    "aws_access_key": "{{env `AWS_ACCESS_KEY`}}",
    "aws_secret_key": "{{env `AWS_SECRET_KEY`}}",
    "aws_security_group_id": "{{env `AWS_SECURITY_GROUP_ID`}}",
    "aws_region": "{{env `AWS_REGION`}}",
    "aws_instance_type": "{{env `AWS_INSTANCE_TYPE`}}",
    "aws_source_ami": "{{env `AWS_SOURCE_AMI`}}",
    "aws_virtualization_type": "{{env `AWS_VIRTUALIZATION_TYPE`}}",
    "server_admin_email": "{{env `PACKER_GRAPHITE_EMAIL`}}",
    "packer_build_name": "{{env `PACKER_GRAPHITE_BUILD_NAME`}}",
    "docker_user": "{{env `DOCKER_USER`}}",
    "server_host_name": "localhost",
    "fedora_repository_name": "My Fedora Repository",
    "fedora_pid_namespace": "my_namespace",
    "tomcat_port": "80",
    "tomcat_ssh_port": "443",
    /* Below generic variables should be supplied by the vars.json file */
    "automatic_os_security_updates": "false",
    "automatic_os_reboot": "false",
    "jvm_memory": "500m",
    "jvm_max_perm_size": "128m",
    "keystore_config": "{{env `KEYSTORE_CONFIG`}}",
    /* These passwords will be autogenerated if left empty */
    "fcrepo3_admin_password": "",
    "fcrepo3_db_password": "",
    "mysql_root_password": "",
    "keystore_password": ""
  },
  "builders": [
    /* Two supported builders at this point: amazon-ebs and docker */
    {
      "type": "amazon-ebs",
      "access_key": "{{user `aws_access_key`}}",
      "secret_key": "{{user `aws_secret_key`}}",
      /* Below should be the actual ID, not the group name */
      "security_group_id": "{{user `aws_security_group_id`}}",
      "region": "{{user `aws_region`}}",
      "associate_public_ip_address": "true",
      /* Make sure the next three values are compatible */
      "source_ami": "{{user `aws_source_ami`}}",
      "instance_type": "{{user `aws_instance_type`}}",
      "ami_virtualization_type": "{{user `aws_virtualization_type`}}",
      /* Build scripts are Ubuntu-specific at this point so the user is fixed */
      "ssh_username": "ubuntu",
      "tags": { "OS_Version": "Ubuntu", "Release": "Fedora Repository {{user `fcrepo3_version`}}" },
      /* Brand our newly created AMIs so that we can easily identify them */
      "ami_name": "{{user `packer_build_name`}} Fedora Repository ({{user `fcrepo3_version`}}) [{{timestamp}}]",
      "ami_description": "A Fedora Repository ({{user `fcrepo3_version`}}) deployment built with Packer.io"
    },
    {
      "type": "docker",
      /* Ubuntu's last Long Term Service (LTS) release */
      "image": "ubuntu:14.04",
      "commit": "true",
      "pull": "true"
    }
  ],
  "provisioners": [
    /* Copies Fedora installation configuration over so it can be used in installation */
    {
      "type": "file",
      "source": "configs/fedora-install.properties",
      "destination": "/tmp/fedora-install.properties"
    },
    {
      "type": "file",
      "source": "scripts/reconfigure-fedora.sh",
      "destination": "/tmp/reconfigure-fedora.sh"
    },
    /* The Fedora installation / configuration options common to all build artifacts */
    {
      "type": "shell",
      "environment_vars": [
        "ROOT_DB_PASSWORD={{user `mysql_root_password`}}",
        "KEYSTORE_PASSWORD={{user `keystore_password`}}",
        "KEYSTORE_CONFIG={{user `keystore_config`}}",
        "JVM_MEMORY={{user `jvm_memory`}}",
        "JVM_MAX_PERM_SIZE={{user `jvm_max_perm_size`}}",
        "FEDORA_DB_PASSWORD={{user `fcrepo3_db_password`}}",
        "FEDORA_ADMIN_PASSWORD={{user `fcrepo3_admin_password`}}",
        "FEDORA_VERSION={{user `fcrepo3_version`}}",
        "TOMCAT_PORT={{user `tomcat_port`}}",
        "TOMCAT_SSH_PORT={{user `tomcat_ssh_port`}}",
        "SERVER_HOST_NAME={{user `server_host_name`}}",
        "FEDORA_REPOSITORY_NAME={{user `fedora_repository_name`}}",
        "FEDORA_PID_NAMESPACE={{user `fedora_pid_namespace`}}",
        "GSEARCH_VERSION={{user `gsearch_version`}}",
        "FEDORA_SERVICES_VERSION={{user `fcrepo3_services_version`}}",
        "SOURCEFORGE={{user `sourceforge_downloads`}}"
      ],
      "scripts": [
        "scripts/setup-base-system.sh",
        /* Going to put MySQL on this machine instead of using an external one */
        "scripts/install-mysql.sh",
        "scripts/install-tomcat.sh",
        "scripts/install-fedora.sh",
        "scripts/install-gsearch.sh",
        "scripts/configure-authbind.sh"
      ]
    },
    {
      "type": "shell",
      "except": ["docker"],
      "environment_vars": [
        "PACKER_FCREPO3_REPO={{user `packer_fcrepo3_repo`}}",
        "SERVER_HOST_NAME={{user `server_host_name`}}",
        "SERVER_ADMIN_EMAIL={{user `server_admin_email`}}",
        "AUTOMATIC_OS_SECURITY_UPDATES={{user `automatic_os_security_updates`}}",
        "AUTOMATIC_OS_REBOOT={{user `automatic_os_reboot`}}"
      ],
      "scripts": [
        "scripts/install-reconfigure-fedora.sh",
        "scripts/modify-landscape.sh",
        "scripts/configure-base-system.sh"
      ]
    },
    {
      "type": "shell",
      "only": ["docker"],
      "script": "scripts/install-supervisor.sh"
    }
  ],
  "post-processors": [
    {
      "type": "docker-tag",
      "only": ["docker"],
      "repository": "{{user `docker_user`}}/packer-fcrepo3",
      "tag": "{{user `packer_fcrepo3_version`}}"
    }
  ]
}
